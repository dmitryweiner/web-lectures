<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Sequelize</title>
    <link rel="shortcut icon" href="./favicon.ico"/>
    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/serif.css" id="theme" />
    <link rel="stylesheet" href="./css/highlight/zenburn.css" />

  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section  data-markdown><script type="text/template">

### ORM `Sequelize` + Node.js
![Sequelize](assets/sequelize/logo.png)

[все лекции](https://github.com/dmitryweiner/web-lectures/blob/main/README.md)

[видео](https://youtu.be/ZO51ORYhSvg)</script></section><section  data-markdown><script type="text/template">
### ORM 

> [Object-Relational Mapping](https://ru.wikipedia.org/wiki/ORM) — объектно-реляционное отображение или преобразование, «виртуальная объектная база данных».</script></section><section  data-markdown><script type="text/template">
![](assets/sequelize/structure.png)</script></section><section  data-markdown><script type="text/template">
### Установка 
```shell
npm i sequelize sqlite3
```
[Документация](https://sequelize.org/)</script></section><section  data-markdown><script type="text/template">
### Подключение
```js
const { Sequelize } = require('sequelize');
const sequelize = new Sequelize({
  dialect: 'sqlite', // тип базы
  storage: 'path/to/database.sqlite' // путь до базы и имя
});
```</script></section><section  data-markdown><script type="text/template">
### Модель
* Модель — это абстракция, представляющая таблицу в БД.
* Модель определяет название таблицы, то, какие колонки она содержит и их типы данных.
* Имя модели в единственном числе, имя таблицы автоматически во множественном.
* [Подробнее](https://sequelize.org/docs/v6/core-concepts/model-basics/).</script></section><section  data-markdown><script type="text/template">
### Определяем модель
```js
const User = sequelize.define('User', {
  // Model attributes are defined here
  id: {
    type: DataTypes.INTEGER,
    autoIncrement: true,
    primaryKey: true
  },
  firstName: {
    type: DataTypes.STRING,
    allowNull: false
  },
  lastName: {
    type: DataTypes.STRING
    // allowNull defaults to true
  }
}, {
  // Other model options go here
});
``` </script></section><section  data-markdown><script type="text/template">
### Поля createdAd, modifiedAt
* Поля createdAd, modifiedAt создаются вручную, специально их создавать не надо.
* Если это поведение надо отключить:

```js
const User = sequelize.define('user', { /* ... */ }, {
  // don't add the timestamp attributes (updatedAt, createdAt)
  timestamps: false,

  // If don't want createdAt
  createdAt: false,

  // If don't want updatedAt
  updatedAt: false,
});
```</script></section><section  data-markdown><script type="text/template">
### Синхронизация модели с БД
* `User.sync()` - создаёт таблицу, если её нет, ничего не делает, если она есть.
* `User.sync({ force: true })` - стирает таблицу, если есть, создаёт заново.
* `User.sync({ alter: true })` - обновляем поля таблицы, если она уже есть.
* `await User.drop()` - удаление таблицы. 
* `await sequelize.sync({ force: true })` - синхронизация всех таблиц.</script></section><section  data-markdown><script type="text/template">
### Работа с моделью
* [Документация](https://sequelize.org/docs/v6/core-concepts/model-querying-basics/).
* INSERT:
```js
const jane = User.create({ name: "Jane" });
```
* UPDATE:
```js
const jane = await User.create({ name: "Jane" });
jane.set({
    name: "Ada"
});
// As above, the database still has "Jane" and "green"
await jane.save();
```</script></section><section  data-markdown><script type="text/template">
### Работа с моделью
* DELETE:
```js
const jane = await User.create({ name: "Jane" });
await jane.destroy();
```
* SELECT:
```js
const users = await User.findAll();
```
* SELECT WHERE:
```js
Post.findAll({
    where: {
      authorId: 2
    }
});
```</script></section><section  data-markdown><script type="text/template">
### Find
* findAll - выборка всех данных.
* findByPk - выборка строки по первичному ключу.
* findOne - выборка одной строки.
* findOrCreate - если не нашли создать.
* findAndCountAll - подсчёт найденных строк.
* https://sequelize.org/docs/v6/core-concepts/model-querying-finders/</script></section><section  data-markdown><script type="text/template">
### Связи между таблицами
* Один к одному:
```js
User.hasOne(Token);
Token.belongsTo(User);
```
* Один ко многим:
```js
User.hasMany(Token);
Token.belongsTo(User);
```
* Многие ко многим:
```js
User.belongsToMany(Token);
Token.belongsToMany(User);
```
* [Подробнее](https://sequelize.org/docs/v6/core-concepts/assocs/).</script></section><section  data-markdown><script type="text/template">
### Поля таблицы для связи
* Специально создавать поля для связи не надо, это происходит автоматически.
* Можно задать:
  * имя;
  * поведение при удалении;
  * можно ли NULL;

```js
Project.belongsTo(User, { 
    foreignKey: {
        name: 'id_manager',
        allowNull: false
    },
    onUpdate: 'CASCADE',
    onDelete: 'CASCADE',
});
```</script></section><section  data-markdown><script type="text/template">
### Полезные ссылки
* [Демо-репозиторий](https://github.com/dmitryweiner/express-auth-example/commit/9bb11f6c2c38d9d08e43361d44aff17161801471).
* https://sequelize.org/
* https://habr.com/ru/post/566036/
* https://habr.com/ru/post/565062/
</script></section></div>
    </div>

    <script src="./dist/reveal.js"></script>

    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/zoom/zoom.js"></script>
    <script src="./plugin/notes/notes.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {}, queryOptions);
    </script>


    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
